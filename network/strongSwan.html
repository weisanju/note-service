<!DOCTYPE HTML>
<html lang="zh_CN" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>strongSwan.md - 计算机网络</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="DNS&DHCP.html"><strong aria-hidden="true">0.</strong> DNS&DHCP.md</a></li><li class="chapter-item "><a href="SSH代理.html"><strong aria-hidden="true">1.</strong> SSH代理.md</a></li><li class="chapter-item "><a href="Socks5协议.html"><strong aria-hidden="true">2.</strong> Socks5协议.md</a></li><li class="chapter-item "><a href="dns-searchdomain.html"><strong aria-hidden="true">3.</strong> dns-searchdomain.md</a></li><li class="chapter-item "><a href="ipsec-l2tpd.html"><strong aria-hidden="true">4.</strong> ipsec-l2tpd.md</a></li><li class="chapter-item expanded "><a href="strongSwan.html" class="active"><strong aria-hidden="true">5.</strong> strongSwan.md</a></li><li class="chapter-item "><a href="systemd&rsolved.html"><strong aria-hidden="true">6.</strong> systemd&rsolved.md</a></li><li class="chapter-item "><a href="tcpdump.html"><strong aria-hidden="true">7.</strong> tcpdump.md</a></li><li class="chapter-item "><a href="v2rayN代理.html"><strong aria-hidden="true">8.</strong> v2rayN代理.md</a></li><li class="chapter-item "><a href="路由器映射后公网能正常访问但局域网无法通过公网IP访问.html"><strong aria-hidden="true">9.</strong> 路由器映射后公网能正常访问但局域网无法通过公网IP访问.md</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title">计算机网络</h1>

                    <div class="right-buttons">

                    </div>
                </div>


                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="/note-service/network/infisearch_assets/search-ui-light.css">
<style>.light .infi-root,
.rust .infi-root,
.coal .infi-root,
.navy .infi-root,
.ayu .infi-root {
    --infi-shadow: none;
    --infi-border: 3px solid var(--table-header-bg);
    --infi-bg: var(--bg);
    --infi-triangle-bg: var(--table-header-bg);
    --infi-item-box-shadow: 0 1px 5px rgba(196, 192, 187, 0.8);
    --infi-title-fg: var(--fg);
    --infi-title-hover-fg: var(--fg);
    --infi-title-hover-bg: var(--table-header-bg);
    --infi-title-border-bottom-hover: 2px solid var(--table-header-bg);
    --infi-heading-fg: var(--fg);
    --infi-heading-hover-fg: var(--fg);
    --infi-body-fg: var(--fg);
    --infi-body-hover-fg: var(--fg);
    --infi-sub-bg: var(--bg);
    --infi-highlight: var(--search-mark-bg);
    --infi-highlight-bg: none;
    --infi-header-fg: var(--fg);
    --infi-checkbox-bg: #f8f8f8;
    --infi-checkbox-checked-bg: #fff;
    --infi-checkbox-border: #414141;
    --infi-filter-header-active: var(--infi-title-bg);
    --infi-error-fg: var(--fg);
    --infi-fine-print-fg: var(--fg);
    --infi-loading-bg: var(--fg);
    --infi-loading-secondary-bg: var(--fg);
    --infi-load-more-fg: var(--infi-title-fg);
    --infi-load-more-bg: var(--infi-title-bg);
    --infi-load-more-hover-fg: var(--infi-title-hover-fg);
    --infi-load-more-hover-bg: var(--infi-title-hover-bg);
    --infi-scrollbar-bg: none;
    --infi-scrollbar-thumb-bg: var(--sidebar-non-existant);
    --infi-fs-button-input-fg: var(--searchbar-shadow-color);
    --infi-fs-border: 3px solid var(--sidebar-bg);
    --infi-fs-box-shadow: none;
    --infi-fs-header-bg: var(--sidebar-bg);
    --infi-fs-header-box-shadow: none;
    --infi-tip-table-header-border: var(--table-border-color);
    --infi-tip-table-border: transparent;
    --infi-tip-table-alternate: var(--table-alternate-bg);
    --infi-tip-bg: var(--sidebar-bg);
    --infi-tip-fg: var(--sidebar-fg);
    --infi-tip-code-fg: var(--inline-code-color);
    --infi-tip-code-bg: transparent;
    --infi-tip-icon-bg: rgb(230, 230, 230);
    --infi-tip-icon-fg: rgb(80, 80, 80);
}

.light .infi-root {
    --infi-fs-header-close-fg: var(--searchresults-header-fg);
    --infi-fs-header-close-hover-fg: var(--fg);
}

.ayu .infi-root,
.rust .infi-root,
.coal .infi-root,
.navy .infi-root {
    --infi-fs-header-close-fg: var(--sidebar-fg);
    --infi-fs-header-close-hover-fg: white;
}

.ayu .infi-root,
.rust .infi-root {
    --infi-tip-code-fg: var(--search-mark-bg) !important;
    --infi-tip-icon-bg: rgb(200, 200, 200);
    --infi-tip-icon-fg: rgb(50, 50, 50);
}

.light .infi-root .infi-list-item.focus,
.rust .infi-root .infi-list-item.focus,
.coal .infi-root .infi-list-item.focus,
.navy .infi-root .infi-list-item.focus,
.ayu .infi-root .infi-list-item.focus {
    outline: 2px solid grey;
}

.light .infi-root,
.coal .infi-root,
.navy .infi-root,
.ayu .infi-root {
    --infi-title-bg: var(--theme-hover);
    --infi-sub-hover-bg: var(--table-alternate-bg);
    --infi-title-border-bottom: 2px solid var(--theme-hover);
}

.light .infi-root {
    --infi-highlight: #82a6c4;
    --infi-sub-hover-bg: #ebebeb;
}

.rust .infi-root {
    --infi-highlight: #bc8e6a;

    --infi-tip-table-alternate: var(--sidebar-bg);
    --infi-title-bg: var(--table-header-bg);
    --infi-title-border-bottom: 2px solid var(--table-header-bg);

    --infi-sub-hover-bg: #c6bbb1;
    --infi-title-bg: #bbada1;
    --infi-title-border-bottom: 2px solid #bbada1;
    --infi-title-hover-fg: #000;
    --infi-title-hover-bg: #a19488;
    --infi-title-border-bottom-hover: 2px solid #a19488;
    --infi-body-hover-fg: #1e1e1e;
    --infi-heading-hover-fg: #1e1e1e;
}

.coal .infi-root {
    --infi-highlight: #496c8a;
    --infi-sub-hover-bg: #272a2b;
}

.infi-theme .infi-root .infi-tip-item code,
.rust .infi-root .infi-tip-item code {
    color: var(--infi-tip-code-fg) !important;;
}

.coal .infi-root,
.navy .infi-root,
.ayu .infi-root {
    --infi-item-box-shadow: 0 1px 5px rgb(50, 50, 50);
    --infi-fs-input-fg: var(--fg);
    --infi-fs-input-focus-border: 2px solid #4f95cc;
    --infi-fs-input-focus-box-shadow: 0 0 5px -1px #63baff;
    --infi-key-fg: #fff;
    --infi-key-bg: #7d7d7d;
    --infi-checkbox-bg: #313233;
    --infi-checkbox-checked-bg: #424243;
    --infi-checkbox-border: #525354;
}

.rust .infi-root {
    --infi-fs-input-fg: var(--sidebar-fg);
    --infi-fs-input-bg: #29201d;
    --infi-fs-input-border: 2px solid #584d4a;
    --infi-fs-input-focus-border: 2px solid #4f95cc;
    --infi-fs-input-focus-box-shadow: 0 0 5px -1px #63baff;
}

.coal .infi-root {
    --infi-fs-input-bg: #1d1f21;
    --infi-fs-input-border: 2px solid #3e4144;
}

.navy .infi-root {
    --infi-fs-input-bg: #1e222f;
    --infi-fs-input-border: 2px solid #3d4252;
    --infi-sub-hover-bg: #242734;
}

.ayu .infi-root {
    --infi-fs-input-fg: var(--fg);
    --infi-fs-input-bg: #2b3035;
    --infi-fs-input-border: 2px solid #43474c;
    --infi-fs-input-focus-border: 2px solid #4f95cc;
    --infi-fs-input-focus-box-shadow: 0 0 5px -1px #63baff;
    --infi-sub-hover-bg: #282e35;
}

#infi-search {
    width: 100%;
    border-radius: 3px;
    box-sizing: border-box;
    padding: 10px 16px;
    border: 1px solid var(--searchbar-border-color);
    background: var(--searchbar-bg);
    color: var(--searchbar-fg);
}

#infi-search:focus:not(.infi-button-input) {
    box-shadow: 0 0 3px var(--searchbar-shadow-color);
}

#infi-search.infi-button-input {
    width: 100px;
}

#infi-search.infi-button-input::placeholder {
    position: relative;
    left: 14px;
}

#infi-search.infi-button-input:hover {
    transition: 0.3s ease-out;
    background: var(--infi-fs-button-input-bg) !important;
    outline: 2px solid var(--infi-fs-button-input-bg);
}

#infi-search.infi-button-input:hover::placeholder {
    color: var(--infi-fs-button-input-fg) !important;
}

@media print {
    #infi-search {
        display: none;
    }
}

#infisearch-mdbook-target {
    position: relative;
}

/*
 * For this plugin, don't show the controls until there is a query.
 */
#infisearch-mdbook-target.infi-empty-input > * {
    display: none;
}

.infi-root:not(.infi-fs-root) {
    display: block;
}

.light .infi-root .infi-title::after,
.rust .infi-root .infi-title::after,
.coal .infi-root .infi-title::after,
.navy .infi-root .infi-title::after,
.ayu .infi-root .infi-title::after {
    content: none;
    display: none;
}

.infi-header {
    padding-bottom: 9px;
}

.infi-load-more {
    padding: 7px 15px;
}
</style>
<p><input
    type="search"
    id="infi-search"
    placeholder="Search this book ..."
/></p>
<p><span style="font-weight: 600;"><!--preload weight 600--></span></p>
<div id="infisearch-mdbook-target"></div>
<h2 id="strongswan简介"><a class="header" href="#strongswan简介">strongSwan简介</a></h2>
<h3 id="securing-a-network"><a class="header" href="#securing-a-network">Securing a Network</a></h3>
<p>strongSwan是一个完整的 IPsec 解决方案，为服务器和客户端提供加密和身份验证。strongSwan可用于保护与远程网络的通信，就如同本地通信一样</p>
<h4 id="gateway"><a class="header" href="#gateway">Gateway</a></h4>
<p>网关通常是你的防火墙。同时也会承担小网络中的 DHCP DNS</p>
<h3 id="remote-access--roadwarrior-clients"><a class="header" href="#remote-access--roadwarrior-clients">Remote Access / Roadwarrior Clients</a></h3>
<p>“Roadwarriors” 在 VPN 和网络安全领域中是一个术语，通常指的是需要从不同地点、通过公共网络（如互联网）连接到公司内部网络的远程用户。这些用户可能是在家办公的员工、经常出差的人员，或者其他需要远程访问公司资源的用户。</p>
<p>在 StrongSwan 的文档中 <strong>roadwarriors</strong> 这个术语具体指的是那些使用 IPsec VPN 客户端，从任何地方（不固定位置）连接到公司 VPN 网关的用户。为这些用户配置 VPN 可以确保他们的连接安全、数据加密，从而保护公司网络和信息的安全。</p>
<h3 id="remote-hosts--host-to-host"><a class="header" href="#remote-hosts--host-to-host">Remote Hosts / Host-to-Host</a></h3>
<p>This can be a remote web server or a backup system. This is illustrated in the image by host <code>**winnetou**</code> and either of the gateways <code>**moon**</code> and <code>**sun**</code>. The connection between the two hosts can usually be initiated by either one of them.</p>
<p>这可以是远程web服务器或备份系统</p>
<h3 id="remote-sites--site-to-site"><a class="header" href="#remote-sites--site-to-site">Remote Sites / Site-to-Site</a></h3>
<p>位于不同位置的两个或更多子网中的主机应该能够相互访问。且能够加密通信</p>
<h2 id="ike-and-ipsec-basics"><a class="header" href="#ike-and-ipsec-basics">IKE and IPsec Basics</a></h2>
<p><strong>strongSwan</strong> is basically a keying daemon that uses the <a href="https://docs.strongswan.org/docs/5.9/howtos/ipsecProtocol.html#_internet_key_exchange_version_2_ikev2">Internet Key Exchange Version 2</a> (IKEv2) protocol to establish <strong>Security Associations</strong> (SAs) and negotiate <strong>Security Policies</strong> (SPs) between two peers. For legacy applications <a href="https://en.wikipedia.org/wiki/Internet_Key_Exchange">IKEv1</a> is still supported, although we strongly discourage from using IKEv1 due to stability and some security reasons (it is now <a href="https://datatracker.ietf.org/doc/html/rfc9395">officially deprecated</a>).</p>
<p>IKE provides strong authentication of both peers and derives unique cryptographically-strong session keys. Such an IKE session is often denoted <strong>IKE_SA</strong> in our documentation. Besides authentication and key material IKE also provides the means to exchange configuration information (e.g. <a href="https://docs.strongswan.org/docs/5.9/features/vip.html">virtual IP</a> addresses) and to negotiate IPsec SAs, which are often called <strong>CHILD_SAs</strong>. IPsec SAs define which network traffic is to be secured and how it has to be encrypted and authenticated.</p>
<p>A CHILD_SA consists of two components:</p>
<ol>
<li>The actual IPsec SAs (two of them are established, one in each direction) describing the algorithms and keys used to encrypt and authenticate the traffic.</li>
<li>The policies (there are at least two) that define which network traffic shall use that SA.</li>
</ol>
<p>The policies work both ways, i.e. only traffic matching an inbound policy will be allowed after decryption. Policies are derived from the <strong>traffic selectors</strong> (TS) negotiated via IKE when establishing a CHILD_SA. Unprotected traffic that the kernel receives and for which there is <strong>no</strong> matching inbound IPsec policy will be dropped. This is a security feature.</p>
<p>The actual <a href="https://en.wikipedia.org/wiki/IPsec">IPsec traffic</a> is not handled by <strong>strongSwan</strong> but will be relegated to the network and IPsec stack of the operating system kernel. <strong>strongSwan</strong> installs the negotiated IPsec SAs and SPs into the kernel by using a platform-dependent <strong>kernel interface</strong>.</p>
<p>The mentioned distinction between policies and SAs often leads to <strong>misconceptions</strong>. For instance, referring to the image above, if host <code>**moon**</code> has a site-to-site tunnel to host <code>**sun**</code> (connecting the two networks <code>**10.1.0.0/16**</code> and <code>**10.2.0.0/24**</code>) and host <code>**carol**</code> has a roadwarrior connection to host <code>**sun**</code> (from which <code>**carol**</code> received a virtual IP address of <code>**10.3.0.10**</code>). Then <code>**carol**</code> won’t be able to automatically communicate with <code>**alice**</code>, even if forwarding is enabled on <code>**sun**</code>. This is because there is no IPsec policy allowing traffic between <code>**carol**</code> (<code>**10.3.0.10**</code>) and <code>**alice**</code> (<code>**10.1.0.10**</code>). An additional SA between <code>**moon**</code> and <code>**sun**</code> connecting the virtual subnet <code>**10.3.0.0/24**</code> with <code>**10.1.0.0/16**</code> would be a possible solution to this issue.</p>
<p>Generally, IPsec processing and routing are not directly related. IPsec is often just bumped into the network stack and matching traffic is processed transparently (<strong>policy-based</strong>). So any routes to the remote TS will technically work for packets to get forwarded and processed by IPsec. However, source address selection can be a problem when traffic is sent from the VPN host itself. If the local TS don’t include its "public" address, traffic would not get processed if the source address is e.g. selected based on the default route. This is particularly true if virtual IP addresses are used. So to ensure that an address from a local TS is selected as source, the strongSwan <a href="https://docs.strongswan.org/docs/5.9/daemons/charon.html"><code>**charon**</code></a> IKE daemon, by default, installs specific routes to the remote TS for most CHILD_SAs (excluded are e.g. those that use transport mode or TS with specific ports/protocol).</p>
<p>An alternative approach is <a href="https://docs.strongswan.org/docs/5.9/features/routeBasedVpn.html"><strong>route-based</strong> IPsec</a> that uses interfaces and explicit routes to control what packets are going to be processed by IPsec tunnels (traffic routed that way still has to match the negotiated policies).</p>
<p><strong>strongSwan</strong> 基本上是一个密钥守护进程，使用 <a href="https://docs.strongswan.org/docs/5.9/howtos/ipsecProtocol.html#_internet_key_exchange_version_2_ikev2">Internet 密钥交换版本 2</a> (IKEv2) 协议来建立<strong>安全关联</strong> (SAs： <strong>Security Associations</strong> ) 并协商两个对等体之间的<strong>安全策略</strong> (SPs： <strong>Security Policies</strong>)。对于传统应用，<a href="https://en.wikipedia.org/wiki/Internet_Key_Exchange">IKEv1</a> 仍然受支持，尽管由于稳定性和某些安全原因（现已<a href="https://datatracker.ietf.org/doc/html/rfc9395">正式弃用</a>），我们强烈不建议使用 IKEv1。</p>
<p>IKE 提供对两个对等体的强认证并生成唯一的、加密强度高的会话密钥。在我们的文档中，这样的 IKE 会话通常被称为 <strong>IKE_SA</strong>。除了认证和密钥材料，IKE 还提供了交换配置信息（例如<a href="https://docs.strongswan.org/docs/5.9/features/vip.html">虚拟 IP</a> 地址）和协商 IPsec SAs 的手段，后者通常被称为 <strong>CHILD_SAs</strong>。IPsec SAs 定义了<strong>哪些网络流量</strong>需要被保护以及<strong>如何加密和认证这些流量</strong>。</p>
<p>一个 CHILD_SA 由两个组件组成：</p>
<ol>
<li>实际的 IPsec SAs（每个方向建立两个），描述用于加密和认证流量的算法和密钥。</li>
<li>定义哪些网络流量将使用该 SA 的策略（至少有两个）。</li>
</ol>
<p>这些策略是双向工作的，即只有匹配入站策略的流量在解密后才会被允许通过。策略是从在建立 CHILD_SA 时通过 IKE 协商的<strong>流量选择器</strong>（TS： <strong>traffic selectors</strong> (）派生的。内核接收到的没有匹配的入站 IPsec 策略的未保护流量将被丢弃。这是一个安全特性。</p>
<p>实际的 <a href="https://en.wikipedia.org/wiki/IPsec">IPsec 流量</a> 不是由 <strong>strongSwan</strong> 处理的，而是由操作系统内核的网络和 IPsec 堆栈处理的。<strong>strongSwan</strong> 通过使用平台相关的<strong>内核接口</strong>将协商的 IPsec SAs 和 SPs 安装到内核中。</p>
<p>提到的策略和 SAs 之间的区别常常导致<strong>误解</strong>。</p>
<p><img src="https://docs.strongswan.org/docs/5.9/_images/topology.png" alt="topoglogy" /></p>
<p>例如，参考上图，如果主机 <code>**moon**</code> 有一个到主机 <code>**sun**</code> 的站点到站点隧道（连接两个网络 <code>**10.1.0.0/16**</code> 和 <code>**10.2.0.0/24**</code>），并且主机 <code>**carol**</code> 有一个到主机 <code>**sun**</code> 的 roadwarrior 连接（从 <code>**sun**</code> 处获得虚拟 IP 地址 <code>**10.3.0.10**</code>）。那么，即使在 <code>**sun**</code> 上启用了转发，<code>**carol**</code> 也无法自动与 <code>**alice**</code> 通信。这是因为没有允许 <code>**carol**</code>（<code>**10.3.0.10**</code>）和 <code>**alice**</code>（<code>**10.1.0.10**</code>）之间流量的 IPsec 策略。在 <code>**moon**</code> 和 <code>**sun**</code> 之间建立一个额外的 SA，连接虚拟子网 <code>**10.3.0.0/24**</code> 和 <code>**10.1.0.0/16**</code>，可能是解决这个问题的一个方法。</p>
<p>一般来说，IPsec 处理和路由不是直接相关的。IPsec 通常只是被集成到网络堆栈中，匹配的流量被透明地处理（基于策略）。因此，任何到远程 TS 的路由在技术上都可以工作，使数据包得以转发和被 IPsec 处理。然而，当流量从 VPN 主机自身发送时，源地址选择可能会成为问题。如果本地 TS 不包括其“公共”地址，那么当基于默认路由选择源地址时，流量将不会被处理。这在使用虚拟 IP 地址时尤为真实。因此，为确保选择本地 TS 的地址作为源，strongSwan <a href="https://docs.strongswan.org/docs/5.9/daemons/charon.html"><code>**charon**</code></a> IKE 守护进程默认情况下会为大多数 CHILD_SAs（不包括使用传输模式或具有特定端口/协议的 TS）安装特定的远程 TS 路由。</p>
<p>一种替代方法是 <a href="https://docs.strongswan.org/docs/5.9/features/routeBasedVpn.html"><strong>基于路由</strong></a> 的 IPsec，它使用接口和显式路由来控制将通过 IPsec 隧道处理哪些数据包（这种方式路由的流量仍必须匹配协商的策略）。</p>
<h2 id="authentication-basics"><a class="header" href="#authentication-basics">Authentication Basics</a></h2>
<p>为了确保建立 IKE_SA 的对等方确实是它所声称的那样，必须对其进行认证。</p>
<p>strongSwan 提供了几种方法来实现这一点：</p>
<h4 id="公钥认证"><a class="header" href="#公钥认证">公钥认证</a></h4>
<p>使用 RSA、ECDSA 或 EdDSA X.509 证书来验证对等方的真实性。</p>
<p>证书可以是自签名的（这种情况下必须安装在所有对等方上）或由公共证书颁发机构（CA）签名的。后者大大简化了部署和配置，因为网关只需要 CA 证书来认证所有提供由该 CA 签名的有效证书的对等方。</p>
<p>可以使用证书撤销列表（CRLs）或在线证书状态协议（OCSP）来验证证书的有效性。</p>
<p>为了安全存储私钥，可以通过 pkcs11 插件使用智能卡。</p>
<p>为了防止中间人攻击，对等方声称的身份必须通过证书确认，无论是通过 subjectDn 还是 subjectAltName 扩展。</p>
<h4 id="预共享密钥认证psk"><a class="header" href="#预共享密钥认证psk">预共享密钥认证（PSK）</a></h4>
<p>预共享密钥是一种易于部署的选项，但它需要强大的秘密才能确保安全。</p>
<p>如果 PSK 为许多用户所知（这在 IKEv1 XAuth with PSK 中经常发生），任何知道该秘密的用户都可以冒充网关。因此，这种方法不推荐用于大规模部署。</p>
<h4 id="可扩展认证协议eap"><a class="header" href="#可扩展认证协议eap">可扩展认证协议（EAP）</a></h4>
<p>这涵盖了几种可能的认证方法，有些基于用户名/密码认证（EAP-MD5、EAP-MSCHAPv2、EAP-GTC）或 X.509 证书（EAP-TLS）。有些甚至可以隧道其他 EAP 方法（EAP-TTLS、EAP-PEAP）。</p>
<p>用户的实际认证可以通过 eap-radius 插件委托给 RADIUS 服务器。</p>
<p>EAP 认证只能与 IKEv2 一起使用，并且对于某些方法，使用 xauth-eap 插件可以与 IKEv1 一起使用。</p>
<h4 id="扩展认证xauth"><a class="header" href="#扩展认证xauth">扩展认证（XAuth）</a></h4>
<p>XAuth 在 IKEv1 中提供了一个灵活的认证框架。它主要用于基于用户名/密码的认证。它通常作为基于 X.509 证书或 PSK 的相互认证后的第二种认证方法使用。然而，使用 IKEv1 混合认证，可以通过证书认证网关，并仅使用 XAuth 认证客户端。</p>
<p>使用 IKEv2，可以进行多轮认证（RFC 4739），例如，首先使用 X.509 证书认证机器，然后使用基于用户名/密码的认证方案（例如 EAP-MSCHAPv2）认证用户。还可以使用不对称认证，例如在第一轮认证中通过证书认证网关，通过基于用户名/密码的 EAP 方法认证客户端。请注意，并非所有 IKEv2 实现都支持 RFC 4739 扩展。</p>
<p>我们的网站提供了数十个配置示例，涵盖了这些和其他认证选项。</p>
<h2 id="configuration-files"><a class="header" href="#configuration-files">Configuration Files</a></h2>
<p>The recommended way of configuring strongSwan is via the powerful <a href="https://docs.strongswan.org/docs/5.9/plugins/vici.html"><code>**vici**</code></a> control interface and the <a href="https://docs.strongswan.org/docs/5.9/swanctl/swanctl.html"><code>**swanctl**</code></a> command line tool. The <a href="https://docs.strongswan.org/docs/5.9/swanctl/swanctlConf.html"><code>**swanctl.conf**</code></a> configuration file used by <a href="https://docs.strongswan.org/docs/5.9/swanctl/swanctl.html"><code>**swanctl**</code></a> is stored together with certificates and corresponding private keys in the <a href="https://docs.strongswan.org/docs/5.9/swanctl/swanctlDir.html"><code>**swanctl**</code></a> directory.</p>
<p>Global strongSwan settings as well as plugin-specific configurations are defined in <a href="https://docs.strongswan.org/docs/5.9/config/strongswanConf.html"><code>**strongswan.conf**</code></a>.</p>
<p>Alternatively, the legacy <code>**stroke**</code> control interface and the <code>**ipsec**</code> command line tool can be used with the deprecated <code>**ipsec.conf**</code> and <code>**ipsec.secrets**</code> configuration files.</p>
<h3 id="other-configuration-sources"><a class="header" href="#other-configuration-sources">Other Configuration Sources</a></h3>
<p>The configuration may also be loaded from an <a href="https://docs.strongswan.org/docs/5.9/config/sqliteDbSchema.html">SQL database</a> or can be provided by custom plugins. Using the <code>**charon-nm**</code> daemon variant, the <a href="https://docs.strongswan.org/docs/5.9/features/networkManager.html">NetworkManager</a> can be used to manage VPN connections.</p>
<h2 id="invocation-and-maintenance"><a class="header" href="#invocation-and-maintenance">Invocation and Maintenance</a></h2>
<p>在现代发行版中，strongSwan 通常使用 <code>swanctl</code> 命令进行管理，而 IKE charon 守护进程由 <code>systemd</code> 控制。在传统安装中，strongSwan 由 <code>ipsec</code> 命令控制，其中 <code>ipsec start</code> 将启动 starter 守护进程，进而启动并配置密钥管理的 charon 守护进程。</p>
<p>在 <code>swanctl.conf</code> 中定义的 IKE 连接和 CHILD SAs 可以通过三种不同的方式启动：</p>
<h4 id="基于流量"><a class="header" href="#基于流量">基于流量</a></h4>
<p>如果使用 <code>start_action = trap</code>，则会为配置的流量（通过 <code>local_ts</code>/<code>remote_ts</code> 定义）安装 IPsec trap 策略，匹配这些策略的流量将触发获取事件，导致守护进程建立所需的 IKE/IPsec SAs。这也用于 passthrough/drop IPsec 策略，让特定流量绕过其他策略/SAs 或完全丢弃它。</p>
<h4 id="启动时"><a class="header" href="#启动时">启动时</a></h4>
<p>配置了 <code>start_action = start</code> 的 CHILD SAs 会在守护进程启动时自动建立。当它们由于某种原因下线时，不会自动重启。需要指定其他配置设置（<code>dpd_action</code> 和/或 <code>close_action</code>）以自动重启它们，但即便如此，该设置也不完美，可能会导致数据包泄漏。建议使用 trap 策略，并阅读 <code>SecurityRecommendations</code> 以解决任何问题。</p>
<h4 id="手动"><a class="header" href="#手动">手动</a></h4>
<p>没有使用 <code>start_action</code> 的连接必须通过 <code>swanctl --initiate</code> 手动建立，或者被动地作为响应者等待对等方/roadwarrior 连接。根据配置，也可以使用 <code>swanctl --install</code> 手动安装这些连接的策略，就像 <code>start_action = trap</code> 在启动时所做的那样。</p>
<p>在建立 SA 后，可以使用 <code>swanctl --terminate</code> 来拆除 IKE_SA 或单个 CHILD_SAs。</p>
<p>每当 <code>swanctl.conf</code> 文件或 <code>swanctl</code> 目录中的凭证发生更改时，可以使用不同的 <code>swanctl --load-..</code> 命令重新加载这些更改。已经建立的连接不受这些命令的影响（除非使用了 <code>start_action = start</code>）。如果需要更新配置，必须重新启动 SAs 或守护进程。</p>
<p>使用不同的 <code>swanctl --list-..</code> 命令可以提供有关已加载或缓存的证书、支持的算法和已加载插件的信息。</p>
<h2 id="logging-and-monitoring"><a class="header" href="#logging-and-monitoring">Logging and Monitoring</a></h2>
<p>如果遇到问题，提高日志级别可能有助于理解具体出了什么问题。不同的日志选项在单独的文档或 <code>strongswan.conf</code> 手册页中有所描述。调试问题的推荐日志设置可以在这里找到。</p>
<p>每当遇到类似 <code>received … error notify</code> 的日志消息，其中占位符 <code>…</code> 例如 <code>NO_PROPOSAL_CHOSEN</code> 或 <code>TS_UNACCEPTABLE</code> 时，应查阅远程对等方的日志，以找出最初生成该错误通知的原因。</p>
<p><code>swanctl --list-..</code> 命令将提供有关已建立和配置连接的信息。</p>
<p>在 Linux 上，<code>iproute2</code> 包提供了 <code>ip xfrm state</code> 和 <code>ip xfrm policy</code> 命令，可以请求有关内核中安装的 IPsec SAs 和策略的详细信息。添加 <code>-s</code> 选项将显示广泛的统计信息，例如传输或无效数据包的数量。在其他平台上，<code>ipsec-tools</code> 包中的 <code>setkey</code> 命令提供类似的信息。</p>
<p><code>tcpdump</code> 和 <code>wireshark</code> 也常常对调试问题有用。</p>
<p>在使用 <code>ping</code> 测试连接时，确保选择一个包含在本地流量选择器中的源 IP 地址（使用 <code>-I</code> 选项）（也请参阅下面的站点到站点配置）。</p>
<h2 id="pki"><a class="header" href="#pki">PKI</a></h2>
<p>要使用基于证书的认证，您需要创建自签名证书或建立一个完整的公钥基础设施（PKI），包括证书颁发机构（CA）、可选的中间 CA 和终端实体证书，以及证书吊销列表（CRL）或其他方法（如 OCSP）来验证证书的有效性。</p>
<p>生成证书的最简单方法之一是使用 <a href="https://docs.strongswan.org/docs/5.9/pki/pki.html"><code>**pki**</code></a> 工具。由于建立整个 PKI 可能相当复杂，我们提供了一些 <a href="https://docs.strongswan.org/docs/5.9/pki/pkiQuickstart.html">简单的说明</a> 以帮助您入门。</p>
<p>OpenSSL 也是生成证书的广泛替代方案，还有一些基于 GUI 的 <a href="https://docs.strongswan.org/docs/5.9/pki/caManagement.html">CA 管理工具</a>。微软的 <a href="https://docs.microsoft.com/en-us/learn/modules/implement-manage-active-directory-certificate-services/">Active Directory Certificate Services</a>（AD CS）也可以用于大规模 PKI。</p>
<h3 id="证书要求"><a class="header" href="#证书要求">证书要求</a></h3>
<ol>
<li>
<p>生成的终端实体证书需要认证相应的远程 IKE ID 以使对等认证成功。</p>
</li>
<li>
<p>为了使用一个或多个证书（也可以使用属性证书）对另一个 strongSwan 实例进行认证，证书必须认证主机发送的 IKE ID。</p>
<p><em>如果 Alice 试图以 Alice（她自己）的身份对 Bob 进行认证，那么 Alice 的证书必须包含至少一个正确类型（FQDN）和值为 Alice 的 <code>**subjectAltName**</code>（SAN）字段，或者 <code>**subjectDistinguishedName**</code>（DN），而不是 <code>**commonName**</code>（CN），必须为 Alice！</em></p>
<p>换句话说，您可以使用完整的 <code>**DN**</code> 或任何 <code>**SAN**</code> 字段（假设类型正确）作为 IKE ID。有关详细信息，请参阅 <a href="https://docs.strongswan.org/docs/5.9/howtos/introduction.html#_notes_regarding_certificates">关于证书的注释</a>。</p>
</li>
<li>
<p>此外，证书必须被 Bob 信任，要么 Bob 事先知道该证书有效，要么该证书由 Bob 信任的证书颁发机构（CA）颁发。</p>
</li>
<li>
<p>为了认证成功，另一个对等方必须拥有从根证书（根 CA）到终端实体证书（主机或用户证书）的完整 X.509 证书信任链，包括所有中间证书（中间 CA）。这可以通过向远程主机发送任何中间证书或远程主机已在本地安装这些证书来完成。</p>
</li>
</ol>
<p>第三方 IKE 实现的基于证书认证的要求在 <a href="https://docs.strongswan.org/docs/5.9/interop/windowsCertRequirements.html">Microsoft Windows</a> 和 <a href="https://docs.strongswan.org/docs/5.9/interop/ios.html#_certificate_requirements">Apple iOS/macOS</a> 的单独文档中有所说明。</p>
<h3 id="关于证书的注释"><a class="header" href="#关于证书的注释">关于证书的注释</a></h3>
<p>作为 X.509 信任链顶端的根 CA 证书总是自签名的，因此可以被任何人伪造，<code>**永远不要**</code>将其发送到另一个主机。任何对等方必须以可信的方式在本地安装根 CA 证书，且绝不接受通过网络接收到的任何根 CA 证书。</p>
<p>仅在以下任一设置为真时，本地证书才会发送到另一台主机：</p>
<ol>
<li>本地主机在其使用的连接定义中设置了 <code>**connections.&lt;conn&gt;.send_cert = always**</code>。</li>
<li>远程对等方通过发送 CERTREQ 负载向本地对等方请求由可信 CA 颁发的证书，该负载指示从本地主机的证书到其根 CA 证书路径中的一个 CA。</li>
</ol>
<h2 id="routing"><a class="header" href="#routing">Routing</a></h2>
<p>在 Linux 上，strongSwan 默认将路由安装到路由表 220，因此需要内核支持基于策略的路由。</p>
<p>您可以使 charon 守护进程将路由安装到任何您喜欢的表中，或者完全禁用它们。为此，可以在 <code>strongswan.conf</code> 中使用 <code>charon.install_routes</code>、<code>charon.routing_table</code> 和 <code>charon.routing_table_prio</code> 设置。当在两个子网之间建立隧道时，charon 会尝试在隧道的本地子网中找到本地 IP。这样的 IP 必须配置为 global 作用域以便查找。如果找到有效的 IP，charon 会安装一个路由，指向远程子网，其中源 IP 设置为找到的 IP。这会导致如下的路由：</p>
<pre><code>css
复制代码
10.1.0.0/24 via 10.2.0.1 src 10.2.0.2
</code></pre>
<p>在这个例子中，本地 IP 将是 10.2.0.2。远程子网将是 10.1.0.0/24。这是为了使发送到远程子网的数据包使用正确的源 IP。因此，IPsec 策略将匹配，从本地机器到远程子网的流量将通过 IPsec 进行保护。</p>
<p>为了避免与这些路由发生冲突（特别是如果使用虚拟 IP 地址），<code>kernel-netlink</code> 插件会手动解析主机的路由表，以确定发送 IKE 数据包时的合适源地址。在具有（非常）大量路由的主机上，这非常低效。在这种情况下，建议在 <code>strongswan.conf</code> 中设置 <code>charon.plugins.kernel-netlink.fwmark</code>，因为它允许使用更有效的源地址查找。</p>
<p>为了检测连接变化，strongSwan 解析内核在安装或删除路由时发送的事件，因此，当运行在通过动态路由接收大量路由的系统上时，可能会导致高 CPU 负载。可以通过在 <code>strongswan.conf</code> 中设置 <code>charon.process_route = no</code> 来禁用连接变化检测。</p>
<p>如果使用 IPv6，请确保在必要时绕过邻居发现协议（NDP）流量。当隧道传输流量时，可能会遇到 MSS/MTU 问题。请参阅转发和分割隧道的详细信息。</p>
<h2 id="remote-access-configurations远程访问配置"><a class="header" href="#remote-access-configurations远程访问配置">Remote Access Configurations（远程访问配置）</a></h2>
<p>在本节中，我们将展示一些常见远程访问使用案例的示例配置。在这些所谓的“roadwarrior”场景中，移动客户端能够连接到一个远程网络。由于这些客户端很可能从未知的IP地址连接，网关将使用 <code>remote_addrs = %any</code> 来字面上接受来自任何地方的连接。为了简化返回给客户端的流量路由（ <a href="https://docs.strongswan.org/docs/5.9/howtos/forwarding.html">routing traffic back</a> ），并且由于 roadwarriors 通常位于一个或多个NAT设备之后，使用 <a href="https://docs.strongswan.org/docs/5.9/features/vip.html">virtual IP</a> 地址是必要的。</p>
<p>虚拟IP地址可以来自一个独立的子网，或者实际上可以通过使用 <a href="https://docs.strongswan.org/docs/5.9/plugins/farp.html"><code>**farp**</code></a> 插件（以及可选的e <a href="https://docs.strongswan.org/docs/5.9/plugins/dhcp.html"><code>**dhcp**</code></a> 插件）来自网关后面的子网。</p>
<p>需要考虑的另一个问题是，“roadwarriors”是否会将所有的流量发送到网关，或者使用分离隧道（ <a href="https://docs.strongswan.org/docs/5.9/howtos/forwarding.html">split-tunneling</a>,），即只通过隧道发送特定目的地的流量。有关这一点的更详细解释可以在“转发和分离隧道”  <a href="https://docs.strongswan.org/docs/5.9/howtos/forwarding.html">Forwarding and Split-Tunneling</a>. 中找到。该文档还解释了如何将流量转发 <a href="https://docs.strongswan.org/docs/5.9/howtos/forwarding.html">forwarded</a> 给网关后面的主机。</p>
<h3 id="ikev2-configurations"><a class="header" href="#ikev2-configurations">IKEv2 Configurations</a></h3>
<p>The three strongSwan gateway configurations shown for the <a href="https://docs.strongswan.org/docs/5.9/interop/windowsClients.html">Windows clients</a> may be used for all IKEv2 clients:</p>
<ol>
<li><a href="https://docs.strongswan.org/docs/5.9/interop/windowsMachineServerConf.html">Certificate-based Authentication</a></li>
<li><a href="https://docs.strongswan.org/docs/5.9/interop/windowsUserServerConf.html">Certificate-based EAP-TLS Authentication</a></li>
<li><a href="https://docs.strongswan.org/docs/5.9/interop/windowsEapServerConf.html">Password-based EAP Authentication</a></li>
</ol>
<p>In all three use cases the gateway is authenticated by a certificate while the clients either authenticate themselves based on certificates (1, 2) or on username/password schemes (3). The generic EAP use case (3) incorporates the EAP-TLS use case (2), so that only two configurations (1, 3) must be implemented in parallel on a strongSwan VPN gateway to leave it up to the VPN clients to select any of the three authentication methods above.</p>
<p>With the <a href="https://docs.strongswan.org/docs/5.9/plugins/eap-radius.html"><code>**eap-radius**</code></a> plugin, user authentication may be delegated to a RADIUS server (e.g. an existing Active Directory DC).</p>
<p>Both the <a href="https://docs.strongswan.org/docs/5.9/os/androidVpnClient.html">strongSwan VPN Client for Android</a> and <a href="https://docs.strongswan.org/docs/5.9/features/networkManager.html">NetworkManager</a> may be used with any of the strongSwan VPN gateway configurations. Alternatively the <a href="https://docs.strongswan.org/docs/5.9/daemons/charon-cmd.html"><code>**charon-cmd**</code></a> command line IKEv2 client provides a simple means to establish roadwarrior connections.</p>
<p><a href="https://docs.strongswan.org/docs/5.9/os/macos.html#_native_application">Our app for macOS</a> supports IKEv2 and simple EAP authentication. With <a href="https://docs.strongswan.org/docs/5.9/interop/appleIkev2Profile.html">iOS 8 and macOS 10.10</a> Apple introduced support for IKEv2 in their clients. A GUI to configure such connections is currently not provided, so it’s necessary to write (or generate) <a href="https://docs.strongswan.org/docs/5.9/interop/appleIkev2Profile.html">custom configuration profiles</a>.</p>
<h3 id="ikev2-配置"><a class="header" href="#ikev2-配置">IKEv2 配置</a></h3>
<p>为<a href="https://docs.strongswan.org/docs/5.9/interop/windowsClients.html">Windows客户端</a>显示的三种strongSwan网关配置可用于所有IKEv2客户端：</p>
<ol>
<li><a href="https://docs.strongswan.org/docs/5.9/interop/windowsMachineServerConf.html">基于证书的认证</a></li>
<li><a href="https://docs.strongswan.org/docs/5.9/interop/windowsUserServerConf.html">基于证书的EAP-TLS认证</a></li>
<li><a href="https://docs.strongswan.org/docs/5.9/interop/windowsEapServerConf.html">基于密码的EAP认证</a></li>
</ol>
<p>在这三种使用案例中，网关通过证书进行认证，而客户端则通过证书（1，2）或用户名/密码方案（3）进行认证。通用的EAP使用案例（3）包含了EAP-TLS使用案例（2），因此只需在strongSwan VPN网关上并行实现两种配置（1，3），便可让VPN客户端自行选择上述三种认证方法中的任何一种。</p>
<p>通过<a href="https://docs.strongswan.org/docs/5.9/plugins/eap-radius.html"><code>**eap-radius**</code></a>插件，可以将用户认证委托给RADIUS服务器（例如现有的Active Directory DC）。</p>
<p><a href="https://docs.strongswan.org/docs/5.9/os/androidVpnClient.html">strongSwan VPN客户端for Android</a>和<a href="https://docs.strongswan.org/docs/5.9/features/networkManager.html">NetworkManager</a>均可与任何strongSwan VPN网关配置一起使用。或者，<a href="https://docs.strongswan.org/docs/5.9/daemons/charon-cmd.html"><code>**charon-cmd**</code></a>命令行IKEv2客户端提供了一种简单的方法来建立移动用户连接。</p>
<p><a href="https://docs.strongswan.org/docs/5.9/os/macos.html#_native_application">我们为macOS提供的应用程序</a>支持IKEv2和简单EAP认证。在<a href="https://docs.strongswan.org/docs/5.9/interop/appleIkev2Profile.html">iOS 8 和 macOS 10.10</a>中，Apple引入了对其客户端的IKEv2支持。然而，目前并未提供配置此类连接的GUI，因此需要编写（或生成）<a href="https://docs.strongswan.org/docs/5.9/interop/appleIkev2Profile.html">自定义配置文件</a>。</p>
<h2 id="site-to-site-configurations-站点到站点配置"><a class="header" href="#site-to-site-configurations-站点到站点配置">Site-to-Site Configurations （站点到站点配置）</a></h2>
<p>我们提供以下站点到站点配置示例。</p>
<p>与远程访问情况相比，最重要的区别在于发起方不会请求虚拟IP地址，而是使用<code>local_ts</code>来隧道传输一个或多个本地子网的流量。使用IKEv2时，可以将多个子网（CIDR表示法）添加到<code>local_ts</code>/<code>remote_ts</code>中，并用逗号分隔。如果使用IKEv1，需要为每个本地和远程子网组合添加一个独立的<code>children.&lt;child&gt;</code>子部分，因为只有<code>local_ts</code>/<code>remote_ts</code>中的第一个子网会被使用。</p>
<p>一个经常让IPsec新手困惑的问题是，从任一网关测试网对网场景时，通常需要特意选择使用的源地址（例如，用<code>ping -I</code>），因为任一网关的外部IP可能未被包含在隧道子网中。如果这是您需要的，可以将外部IP添加到<code>local_ts</code>/<code>remote_ts</code>的子网列表中，或者添加一个特定的主机对主机配置。</p>
<h2 id="host-to-host-configurations主机到主机配置"><a class="header" href="#host-to-host-configurations主机到主机配置">Host-to-Host Configurations（主机到主机配置）</a></h2>
<p>主机到主机连接设置非常简单。基本上，您只需将<code>remote_addrs</code>设置为对等方的主机名或IP地址，并配置所需的认证方式。既不需要显式设置<code>local_ts</code>，也不需要显式设置<code>remote_ts</code>流量选择器。</p>
<p>同样，我们的网站提供了一些实用的主机到主机配置示例。</p>
<h2 id="roadwarriors由来"><a class="header" href="#roadwarriors由来">Roadwarriors由来</a></h2>
<p>“Roadwarriors” 这个术语来源于一个比喻，形象地描述了那些经常在路上工作、需要远程连接公司网络的用户。这个比喻源自电影《疯狂的麦克斯》（Mad Max）中的角色，他们在一个后末日世界中不断迁徙、争夺资源和生存，被称为“道路战士”。尽管这种情景与办公室员工的工作环境相去甚远，但它形象地描述了这些员工的流动性和灵活性。</p>
<script src="/note-service/network/infisearch_assets/search-ui.chinese.bundle.js" type="text/javascript" charset="utf-8"></script>
<script src="/note-service/network/infisearch_assets/mark.min.js" type="text/javascript" charset="utf-8"></script>
<script>
const base_url = '/note-service/network/';
const mode = 'target';
infisearch.init({
  searcherOptions: {
    url: base_url + 'infisearch_output/',
  },
  uiOptions: {
    mode,
    dropdownAlignment: 'bottom-start',
    target: document.getElementById('infisearch-mdbook-target'),
    fsButtonPlaceholder: 'Search',
    sourceFilesUrl: base_url,
    resultsRenderOpts: {
      searchedTermsParam: 'search',
    },
    multiSelectFilters: [
      { fieldName: 'partTitle', displayName: 'Section', defaultOptName: 'None' },
    ],
  },
});

document.getElementById('infi-search').addEventListener('keydown', (ev) => {
  if (['ArrowLeft', 'ArrowRight'].includes(ev.key)) {
    ev.stopPropagation(); // used in global listener to change pages
    return;
  }
});

if (window.location.search) {
  // Adapted from the original searcher.js for mdbook
  // https://github.com/rust-lang/mdBook/blob/master/src/theme/searcher/searcher.js
  const target = document.getElementById('content');
  const marker = new Mark(target);

  function doSearchOrMarkFromUrl() {
    // Check current URL for search request
    var url = new URL(window.location.href);
    var urlParams = new URLSearchParams(url.search);

    if (urlParams.has('search')) {
      var words = JSON.parse(decodeURIComponent(urlParams.get('search')));
      marker.mark(words);

      var markers = document.querySelectorAll('mark');
      function hide() {
        for (var i = 0; i < markers.length; i++) {
          markers[i].classList.add('fade-out');
          window.setTimeout(function () { marker.unmark(); }, 300);
        }
      }
      for (var i = 0; i < markers.length; i++) {
        markers[i].addEventListener('click', hide);
      }
    }
  }
  doSearchOrMarkFromUrl();
}
</script>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ipsec-l2tpd.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="systemd&amp;rsolved.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ipsec-l2tpd.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="systemd&amp;rsolved.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>



        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
